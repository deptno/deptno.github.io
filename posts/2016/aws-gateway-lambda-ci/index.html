<!DOCTYPE html><html><head><meta charset="utf-8"><title>AWS API Gateway - Lambda - Travis-CI prototype 구현 | 봉로그</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="aws serverless architecture 의 핵심에 api gateway 와 lambda 가 있다. 두 서비스는 모드 서울 리전에서 사용이 가능하다. 이를 이용하여 프로토타입을 작성해 보자."><meta name="keywords" content="aws,ci,api gateway,lambda,travis,lambda 배포"><meta property="og:type" content="article"><meta property="og:title" content="AWS API Gateway - Lambda - Travis-CI prototype 구현"><meta property="og:url" content="http://blog.bglee.me/posts/2016/aws-gateway-lambda-ci/index.html"><meta property="og:site_name" content="봉로그"><meta property="og:description" content="aws serverless architecture 의 핵심에 api gateway 와 lambda 가 있다. 두 서비스는 모드 서울 리전에서 사용이 가능하다. 이를 이용하여 프로토타입을 작성해 보자."><meta property="og:locale" content="ko"><meta property="og:image" content="https://awsblogskr.s3-ap-northeast-2.amazonaws.com/articles/2016-04-serverless/serverless-amazon-s3.png"><meta property="og:image" content="https://lh3.googleusercontent.com/Y5RrAUzYbGCZF1Ei9TI8G8r3rNkEDVtTJxp3unq9N3-CNRfo0oEeLVlD2bBDqmqOM0hNmD5Z4TO-aV7URlndgAjXAHxW5ADU98mW1W-mvbqVIu8mtvdKS8ujNd0Xsxez_jbosmy3zxWeRlyk9tSz3qpm1sNcY3UqWmEYoIyuDUUmhsHAtuW74XnHU93Vq49XQtL6sdOLjUI6QC2Ts3XMR2v6752ZIaISRPXpmxZRpOB6x6ZXXErJ_poJMDqjoCoZJDmtST2ry3-T9tdnz37S-SvuD03g6EmF2ogILD8amHdycwkQWEVKiSNLBiw2-i_gjhIgov7nKowMCPI0BuJRnxyTC7WGitmCjsdtj7nV_G13gvQVz-4CkdOp3EKTwgEjZxq3zzfbpA-wbhgYSoAdSVtzxpwRA1WMIPvhNk7FAp0Afte0hvTaX807p9qvmJgkTw0ebaLV5Aj_M-COz2Mo7vScyYC2Rauan_O3Iu6KlXSNG-5zzF4u0cFjCWnv38xbscccKYZ3kOoY40gt0WajQ0OHG3IFG0YuAS4DUXn_pItE_b_oPaqNRehKPgK1CkcHZlK_1dlYlHRCJZ0dkkWFMirpJ6KpWJbeNEfimzM6KKRkfjg9jg=w1218-h546-no"><meta property="og:image" content="https://lh3.googleusercontent.com/BF-csXtOhMEE6WspJMUm7eZ7c6cr7_aM0Swxx_DFf0JXhE2c1TwVsB3REoLH30XMkyqQ01kiqZzwNumbqLkbpJ8ZUvj1PlXBK599B7kdjy2w38j9OXxwjtyRWo1rrve2TtxcQfaB5RKJrXmMtRiqiTW4Ojx0gig0NblF-l1sefCvQQuAmHDwDihrN0CYvXgRgPIIkV42kH4CW_tUX2rJtdCisScuSp2iJfc8I6piFwXKIIIWtiUFm7aNRFWds9norKHmpZFg9tJNCW6NdGvA_NsB4phrz-i286cgxUqL_UPvrksJ-_vvRAEm4NKi0cvw3qoRa8cDHQJHe-RAZKgcJgrSuyKkv6j8-Qw3MWVAB_ISlObYFAiEL-kt7C4fJ67zRGFa_BQp9dX1EnJZhSLXJ6jA_9RI63uxxrSuMvc0TBOHCwUtH6R5GvjMp_RpSVdHVrCoPYmKJ-qRPZre7SHnz5n9tfgSUfY97hiFLze-EeqYD8Ydc_dYrzyREgMhe-E8xxOzhfTgqQc-jarA-v2HpTiovD8g5AG_gLEbUhvISQJGRaUZXiCeRW-EZ8phipGYN5h5Yz9A7250P6T_9gFvNSGTb_vJKUeTBEL16jM96GdZzLj3Ww=w783-h400-no"><meta property="og:image" content="https://lh3.googleusercontent.com/vGNzrnq8mtX_glpQje0FTPMxqrXSkLpzEgWdDvfRe3oTCy-5dl40FLX9PhS1-i1tE6ECxszAc6U2jcWU3IvcP5tHLE20pmC4SNWx_uF7_bXlBWipFAENk11BSNIgFkws73UNRw2UycbSAp1q1uP7k69dWvuTGf3w2-w3uLcyUBKOSHukkFyFVBjd84nFHNm8b-sDr2RTE6sOdXQtJNsO0oQ6rOzgxu608HLW-iuS-LIdtMx6nNx92OONE-45P4Q05OlrT5QMNloXw2xr4xr-Ri5tq1EYcBbVm24PrePbUgpOhl9ZqKq_MZq-4pwMoYBWNSer4RCyJCuZxwATNn5ylEexzVLKaAYodFPwSFLbQ9ISL5-sZH0ZRVaAq0a1ZHM94bawcO50hOBjfagTF9Lamdc459-QLfk-TJlmHvg6BWWmyj17FAs8hT8Wn8FEKwBHOzmKj96JQOATff4grr2ZCFhM3H_XxF5JgFYkuPjUEOl91oJB3o14KLat8tIYcEmikC-lB6mafVXELgrYUVNDvqTDId3PFbKdDNdXYKevjk-XuSLgL3k7dticdFtCNhTfKSKpUA6MfX4A7wqgiYuJcK69gylm_vGUg1hoXzhWY7Ny2xo4Hw=w1192-h705-no"><meta property="og:image" content="https://lh3.googleusercontent.com/yrQo0p55cgPUD7xTWGpXznNhTalanKmSUtGMWKBTGRNFTuhd3xBZRtlKc9sxsvtYBQclLVeRMvsxhHMC29ONSJ_aXoIqKKSFxulBV2_EDCAd6QuDlu8z5S2dceF1Qj-Es8SjbAg8uE-S0ttxZZIAGvIISN4vK7Y623GnEKb2RhVKPBQW-JB5FN9qgTtYVmCSwDLny9-QFXg7lRZtOeB82Wgn2SiycGyd-wNTyxe6j4cQV12umkC9czZvn2QAwRX_Xl6mzK6nDtoqvXbebe31hxAUUc2DzVnywpIO0LH33a1-vg2KF2Uau9VMfsk0SlC2B-QkXTUdkQSuVDrXN0VXrAfSSiGT6RCF2XwMm9vbK81JV6IH_jlcwxN2jufquEgjMugBCNa0hPFIs4vyj-747FT_9mp-dAlKYWGUF0Cf3rZpE-B-n4nZdiV175Cz0KLVoIuF26cgR2W0SbK2HBxIY3xMdJBnHmwOmr40ailQXudRvPzHXbJk6bS2eYKpz53kAdOOHLHbqHPYgSIKLDtT3CDF4RKQGc-FSkzUcDM93zqYUnGLvcRu2AESbRqq2D6GIjEP_WUUhsUsOtnljyzIvt-BWYNzU8bgD3jUndCmN0cZz_cAQg=w960-h597-no"><meta property="og:image" content="https://lh3.googleusercontent.com/wFO9ggX6eq_T46j0iEYnzGS1yMy74cNWPY9mGU9GhijI2hIxgfut6emscJ607db5BlGgZNPCbcQgBPCKUvYfKtCm3wpZx1xK0mE5-4-i7ABIpDH7GmSAv5o67gPalQTXsFwSvrW0havFns21c3H-PLd-rA80gm-typkeWRxbjKWgM54-gEjAiC2FVEGNdYaso9SQWsnujEUgschszxMhhRaJzC05zD8-L2Nd6ZW4b94ii_xzYjoz4bNrqQiGvMuDExiatSj8AcTg_KsGhm-FgctyyZX0zP8smvh89_sSyLE37y3baz5-9tq9Te42Mkfhj0pIO6zW-lP0ONVYyQhVjtBeZcW4RPzwsfXwunBE_t7vmPGC7yNtRPHChqtBP37XHjNkMNIR4ADhPr_Uyu_yhvk76Gzxw0JXuJATFg9DeT-Ct88_-nLG-9jzb4j1_RgZW0LAgL-BiUObujoweBDBcbmhAlpHP63DZZQ5FeBSyxAVx1u_0vKO8O7qENNDOmOFpiWlrzkjf9YS5OhkQsplCnSUQnjIpVm8K5aQCix8DcvxXhxfpkv_0ZLi5ym6GWLChP8T3-oru4ylc4lgSZwm7K9QUKvyzHbwWakSZGsrguDe2EcvfQ=w599-h412-no"><meta property="og:updated_time" content="2018-03-29T06:03:19.622Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AWS API Gateway - Lambda - Travis-CI prototype 구현"><meta name="twitter:description" content="aws serverless architecture 의 핵심에 api gateway 와 lambda 가 있다. 두 서비스는 모드 서울 리전에서 사용이 가능하다. 이를 이용하여 프로토타입을 작성해 보자."><meta name="twitter:image" content="https://awsblogskr.s3-ap-northeast-2.amazonaws.com/articles/2016-04-serverless/serverless-amazon-s3.png"><link rel="icon" href="../../../favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="../../../icomoon/style.css"><link rel="stylesheet" href="../../../style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="../../../index.html"><span class="b">봉 </span><span class="b">로 </span><span class="b">그 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-aws-gateway-lambda-ci" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">AWS API Gateway - Lambda - Travis-CI prototype 구현</h1><div class="article-meta">Posted on <time class="article-time" datetime="2016-09-25T15:00:00.000Z" itemprop="datePublished">9월 26, 2016</time></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p><code>aws serverless architecture</code> 의 핵심에 <code>api gateway</code> 와 <code>lambda</code> 가 있다. 두 서비스는 모드 서울 리전에서 사용이 가능하다. 이를 이용하여 프로토타입을 작성해 보자.</p></blockquote><h2><span id="architecture">architecture</span></h2><p><code>node</code>로 서버를 구성하는 것을 예로 들자면 아래와 같다.</p><table><thead><tr><th>node application</th><th>express-router</th><th>logic</th></tr></thead><tbody><tr><td>aws</td><td>api gateway</td><td>lambda</td></tr></tbody></table><p>aws에서 제공하는 아키텍쳐 예시를 보면 이해가 쉽다.</p><p><img src="https://awsblogskr.s3-ap-northeast-2.amazonaws.com/articles/2016-04-serverless/serverless-amazon-s3.png" alt="serverless architecture"></p><p><em><a href="https://api.example.com" target="_blank" rel="noopener">https://api.example.com</a></em> 부분을 통해 api gateway에 접근하면 라우팅을 통해 필요한 lambda함수를 콜하게 된다. 그리고 db 등에 데이터를 연산을 하고 다시 사용자에게 응답을 리턴한다.</p><p>이 포스트는 실무에 적용이 가능하도록 아래와 같은 내용을 담고있다.</p><ul><li>lambda 함수 생성</li><li>api gateway - lambda 함수 연결(parameter, header 설정)</li><li>development, production 모드를 분리하기 위한 stage 활용</li><li>travis ci를 통한 배포 자동화</li></ul><p>실제 구현 순서와는 상관없이 설명하기 편하게 상향식 접근 방법으로 작성한다.</p><h2><span id="lambda-함수-구현">lambda 함수 구현</span></h2><h3><span id="코드-구현-방식">코드 구현 방식</span></h3><p>lambda는 다음 3가지 방식으로 코드를 구현 할 수 있다.</p><ul><li>inline editing</li><li><strong>upload zip file</strong></li><li>upload from s3</li></ul><p>이 포스트는 배포 자동화까지가 목표이므로 2번째 안으로 진행한다.</p><h3><span id="구현-언어">구현 언어</span></h3><p><code>lambda</code>는 <code>java</code>, <code>python</code> 등 몇가지 언어를 지원하는데 이 포스트는 <code>nodejs</code> 4.3 버전을 기준으로 설명한다. nodejs 4.3은 <code>es2015</code>(a.k.a es6) 를 부분적으로 지원하는데 훌륭하진 않으며 다행이 <code>Promise</code>, <code>Set</code> 정도는 지원을 하고 있다.<br>이외에 코드 작성은 방식은 자유지만 컴파일 또한 비용이며 polyfill등을 이용하게 되는 경우 용량이 늘어나므로 추천하진 않는다.</p><h3><span id="lambda-함수-생성">lambda 함수 생성</span></h3><p>간단하면서도 lambda와 api gateway가 연결되면서 parameter들이 어떻게 전달되는지를 볼 수 있도록 코드를 작성한다. 배포하기 전 빠른 진행을 위해 aws에서 제공하는 <code>inline editor</code>를 사용해 바로 소스를 작성하도록 하자.</p><p><a href="https://console.aws.amazon.com" target="_blank" rel="noopener">aws console</a> 에서<code>lambda</code>를 선택해서 lambda 페이지에 진입한 후 왼쪽 사이드 바에서 <code>functions</code>를 누르고 <code>create a Lambda function</code>을 눌러 lambda 함수를 생성하도록 하자.</p><p><code>Select blueprint</code> 화면이 나오면서 template 들이 보여지는데 <code>skip</code> 버튼을 눌러 다음 스텝으로 간다.</p><p><code>configure triggers</code> 화면이 나오는데 우리는 api call을 통한 실행을 할 것이므로 <code>api gateway</code>를 선택하고 <code>next</code>를 누른다.<br><img src="https://lh3.googleusercontent.com/Y5RrAUzYbGCZF1Ei9TI8G8r3rNkEDVtTJxp3unq9N3-CNRfo0oEeLVlD2bBDqmqOM0hNmD5Z4TO-aV7URlndgAjXAHxW5ADU98mW1W-mvbqVIu8mtvdKS8ujNd0Xsxez_jbosmy3zxWeRlyk9tSz3qpm1sNcY3UqWmEYoIyuDUUmhsHAtuW74XnHU93Vq49XQtL6sdOLjUI6QC2Ts3XMR2v6752ZIaISRPXpmxZRpOB6x6ZXXErJ_poJMDqjoCoZJDmtST2ry3-T9tdnz37S-SvuD03g6EmF2ogILD8amHdycwkQWEVKiSNLBiw2-i_gjhIgov7nKowMCPI0BuJRnxyTC7WGitmCjsdtj7nV_G13gvQVz-4CkdOp3EKTwgEjZxq3zzfbpA-wbhgYSoAdSVtzxpwRA1WMIPvhNk7FAp0Afte0hvTaX807p9qvmJgkTw0ebaLV5Aj_M-COz2Mo7vScyYC2Rauan_O3Iu6KlXSNG-5zzF4u0cFjCWnv38xbscccKYZ3kOoY40gt0WajQ0OHG3IFG0YuAS4DUXn_pItE_b_oPaqNRehKPgK1CkcHZlK_1dlYlHRCJZ0dkkWFMirpJ6KpWJbeNEfimzM6KKRkfjg9jg=w1218-h546-no" alt=""></p><p><code>configuration function</code> 에서는 함수에 대한 설정을 한다. 아래와 같이 설정한다.</p><table><thead><tr><th>config</th><th>value</th></tr></thead><tbody><tr><td>Name</td><td>loopbackArgument</td></tr><tr><td>Description</td><td></td></tr><tr><td>Runtime</td><td>Node.js 4.3</td></tr><tr><td>code entry type</td><td>Edit code inline)</td></tr></tbody></table><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    callback(<span class="literal">null</span>, &#123;</span><br><span class="line">        event: event,</span><br><span class="line">        context: context</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>export</code>할 함수 이름을 정하고(여기선 <code>handler</code>) lambda의 signiture대로 3개의 인자를 받는다. 인자를 간략히 설명하면 다음과 같다.</p><table><thead><tr><th>argument</th><th>description</th></tr></thead><tbody><tr><td>event</td><td>event call에 대한 정보로 parameter, header등이 이 인자로 매핑된다.</td></tr><tr><td>context</td><td>lambda 함수 자체에 대한 정보</td></tr><tr><td>callback</td><td>리턴함수라고 생각하면된다, 첫 번째 인자는 Error 객체, 첫 번째 인자가 null 경우 성공으로 간주되고 2번째 인자가 응답값으로 사용된다.</td></tr></tbody></table><p>이 코드는 단순히 람다 함수의 인자를 그대로 응답하는 <code>handler</code>함수를 반환하고 있다.</p><p>이 외는 기본 설정을 이용하며 <code>role</code>을 정해줘야하는데 이전에 람다를 위한 role을 만들지 않았다면 생성 후 선택하고 <code>next</code>를 함수를 생성한다.</p><h2><span id="api-gateway-lambda-함수-연결parameter-header-설정">api gateway - lambda 함수 연결(parameter, header 설정)</span></h2><p><code>api gateway</code>에서는 라우팅 테이블을 만들때 swagger를 지원한다. 기 구현된 서버가 swagger를 통해 문서화가 되어 있다라면 serverless architecture를 바로 적용할 수 있을 것으로 보인다.<br>특히 swagger에 <a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions.html" target="_blank" rel="noopener">api gateway extensions</a>가 존재하는데 이 부분을 swagger에 함께 작성하게 되면 파라메터나 응답값에 대한 정의를 문서 작성 단계에서 끝낼 수 있다.</p><p>이제 <code>api gateway</code>를 설정할 차례다.</p><h3><span id="api-생성">API 생성</span></h3><p><a href="https://console.aws.amazon.com" target="_blank" rel="noopener">aws console</a> 을 통해 api gateway 서비스에 접속한 후 <code>APIs</code> 메뉴에서 <code>Create API</code>를 누른다.</p><p>New API를 선택하고 <code>API name</code>에 <code>test</code> 라고 작성한다.<br>Actions를 눌러 <code>Create Method</code>를 선택하고 <code>post</code>를 선택한후 check 버튼을 눌러 생성한다.<br>이러면 생성한 <code>POST</code> method에 대해 setup하는 화면이 나오고 이미지와 같이 설정을 하여 위에서 작성한 <code>lambda</code> 함수를 연결한다.</p><p><img src="https://lh3.googleusercontent.com/BF-csXtOhMEE6WspJMUm7eZ7c6cr7_aM0Swxx_DFf0JXhE2c1TwVsB3REoLH30XMkyqQ01kiqZzwNumbqLkbpJ8ZUvj1PlXBK599B7kdjy2w38j9OXxwjtyRWo1rrve2TtxcQfaB5RKJrXmMtRiqiTW4Ojx0gig0NblF-l1sefCvQQuAmHDwDihrN0CYvXgRgPIIkV42kH4CW_tUX2rJtdCisScuSp2iJfc8I6piFwXKIIIWtiUFm7aNRFWds9norKHmpZFg9tJNCW6NdGvA_NsB4phrz-i286cgxUqL_UPvrksJ-_vvRAEm4NKi0cvw3qoRa8cDHQJHe-RAZKgcJgrSuyKkv6j8-Qw3MWVAB_ISlObYFAiEL-kt7C4fJ67zRGFa_BQp9dX1EnJZhSLXJ6jA_9RI63uxxrSuMvc0TBOHCwUtH6R5GvjMp_RpSVdHVrCoPYmKJ-qRPZre7SHnz5n9tfgSUfY97hiFLze-EeqYD8Ydc_dYrzyREgMhe-E8xxOzhfTgqQc-jarA-v2HpTiovD8g5AG_gLEbUhvISQJGRaUZXiCeRW-EZ8phipGYN5h5Yz9A7250P6T_9gFvNSGTb_vJKUeTBEL16jM96GdZzLj3Ww=w783-h400-no" alt=""></p><p>물론 함수명과 리전은 작업중인 상황에 맞게 넣어야한다.</p><h3><span id="api-설정">API 설정</span></h3><h4><span id="method-request">Method Request</span></h4><p>설정할 것은 없지만 <code>header</code>와 <code>query string</code>이 들어오는 것을 확인하기 위해 이미지와 같이 추가해 둔다.<br><img src="https://lh3.googleusercontent.com/vGNzrnq8mtX_glpQje0FTPMxqrXSkLpzEgWdDvfRe3oTCy-5dl40FLX9PhS1-i1tE6ECxszAc6U2jcWU3IvcP5tHLE20pmC4SNWx_uF7_bXlBWipFAENk11BSNIgFkws73UNRw2UycbSAp1q1uP7k69dWvuTGf3w2-w3uLcyUBKOSHukkFyFVBjd84nFHNm8b-sDr2RTE6sOdXQtJNsO0oQ6rOzgxu608HLW-iuS-LIdtMx6nNx92OONE-45P4Q05OlrT5QMNloXw2xr4xr-Ri5tq1EYcBbVm24PrePbUgpOhl9ZqKq_MZq-4pwMoYBWNSer4RCyJCuZxwATNn5ylEexzVLKaAYodFPwSFLbQ9ISL5-sZH0ZRVaAq0a1ZHM94bawcO50hOBjfagTF9Lamdc459-QLfk-TJlmHvg6BWWmyj17FAs8hT8Wn8FEKwBHOzmKj96JQOATff4grr2ZCFhM3H_XxF5JgFYkuPjUEOl91oJB3o14KLat8tIYcEmikC-lB6mafVXELgrYUVNDvqTDId3PFbKdDNdXYKevjk-XuSLgL3k7dticdFtCNhTfKSKpUA6MfX4A7wqgiYuJcK69gylm_vGUg1hoXzhWY7Ny2xo4Hw=w1192-h705-no" alt=""></p><h4><span id="integration-request">Integration Request</span></h4><p>여기선 <code>Method Request</code>에서 설정한 parameter 들을 받기 위한 설정인데 기본 템플릿을 적용하여 아래 이미지와 같이 설정한다.<br><img src="https://lh3.googleusercontent.com/yrQo0p55cgPUD7xTWGpXznNhTalanKmSUtGMWKBTGRNFTuhd3xBZRtlKc9sxsvtYBQclLVeRMvsxhHMC29ONSJ_aXoIqKKSFxulBV2_EDCAd6QuDlu8z5S2dceF1Qj-Es8SjbAg8uE-S0ttxZZIAGvIISN4vK7Y623GnEKb2RhVKPBQW-JB5FN9qgTtYVmCSwDLny9-QFXg7lRZtOeB82Wgn2SiycGyd-wNTyxe6j4cQV12umkC9czZvn2QAwRX_Xl6mzK6nDtoqvXbebe31hxAUUc2DzVnywpIO0LH33a1-vg2KF2Uau9VMfsk0SlC2B-QkXTUdkQSuVDrXN0VXrAfSSiGT6RCF2XwMm9vbK81JV6IH_jlcwxN2jufquEgjMugBCNa0hPFIs4vyj-747FT_9mp-dAlKYWGUF0Cf3rZpE-B-n4nZdiV175Cz0KLVoIuF26cgR2W0SbK2HBxIY3xMdJBnHmwOmr40ailQXudRvPzHXbJk6bS2eYKpz53kAdOOHLHbqHPYgSIKLDtT3CDF4RKQGc-FSkzUcDM93zqYUnGLvcRu2AESbRqq2D6GIjEP_WUUhsUsOtnljyzIvt-BWYNzU8bgD3jUndCmN0cZz_cAQg=w960-h597-no" alt=""></p><h3><span id="api-deploy">API Deploy</span></h3><p>사용을 위해 Resources 옆 Actions 를 선택하고 <code>Deploy API</code>를 선택한다.</p><p><img src="https://lh3.googleusercontent.com/wFO9ggX6eq_T46j0iEYnzGS1yMy74cNWPY9mGU9GhijI2hIxgfut6emscJ607db5BlGgZNPCbcQgBPCKUvYfKtCm3wpZx1xK0mE5-4-i7ABIpDH7GmSAv5o67gPalQTXsFwSvrW0havFns21c3H-PLd-rA80gm-typkeWRxbjKWgM54-gEjAiC2FVEGNdYaso9SQWsnujEUgschszxMhhRaJzC05zD8-L2Nd6ZW4b94ii_xzYjoz4bNrqQiGvMuDExiatSj8AcTg_KsGhm-FgctyyZX0zP8smvh89_sSyLE37y3baz5-9tq9Te42Mkfhj0pIO6zW-lP0ONVYyQhVjtBeZcW4RPzwsfXwunBE_t7vmPGC7yNtRPHChqtBP37XHjNkMNIR4ADhPr_Uyu_yhvk76Gzxw0JXuJATFg9DeT-Ct88_-nLG-9jzb4j1_RgZW0LAgL-BiUObujoweBDBcbmhAlpHP63DZZQ5FeBSyxAVx1u_0vKO8O7qENNDOmOFpiWlrzkjf9YS5OhkQsplCnSUQnjIpVm8K5aQCix8DcvxXhxfpkv_0ZLi5ym6GWLChP8T3-oru4ylc4lgSZwm7K9QUKvyzHbwWakSZGsrguDe2EcvfQ=w599-h412-no" alt=""></p><p>이미지와 같이 <code>[New Stage]</code> 로 <code>prod</code>를 입력 후 deploy 버튼을 누르면 <code>Stages</code> 화면으로 진입하면서 <code>endpoint</code>가 될 url이 <code>Invoke URL</code> 이라는 이름으로 보인다.<br>이제 이 url을 통해 api call 이 가능하며 당장 <code>postman</code>이나 <code>curl</code>등을 통해 확인이 가능하다.</p><p>1차적으로 <code>api gateway</code>와 <code>lambda</code>함수를 연결해서 실행을 확인해 볼 수 있는 상태가 되었다.</p><h2><span id="development-production-모드를-분리하기-위한-stage-활용">development, production 모드를 분리하기 위한 stage 활용</span></h2><p>작성한 코드를 실행해보면 아래와 같은 형태의 <code>json</code>이 응답으로 전달됨을 확인 할 수 있다.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"event"</span>: &#123;</span><br><span class="line">    <span class="attr">"body-json"</span>: &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">    "params": &#123;</span><br><span class="line">      "path": &#123;&#125;,</span><br><span class="line">      "querystring": &#123;</span><br><span class="line">        "deptno-param": "deptno test"</span><br><span class="line">      &#125;,</span><br><span class="line">      "header": &#123;</span><br><span class="line">        "Authorization": "deptno test"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "stage-variables": &#123;&#125;,</span><br><span class="line">    "context": &#123;,</span><br><span class="line">      "http-method": "POST",</span><br><span class="line">      "stage": "prod",</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "context": &#123;</span><br><span class="line">    "memoryLimitInMB": "128",</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Integration Request</code>에서 설정한 기본 템플릿을 통해 전달된 event 오브젝트와 context 객체의 내용이 구현한 함수의 기능대로 동작한다면 위와 같은 결과 값을 받을 수 있으며, 코드에 보여지는 부분들은 자주 참조 되는 영역만을 코드에 표시했다.</p><p>event 객체의 구조는 앞으로 사용할 lambda 함수에서 event 객체를 사용하는 <code>reference</code>가 된다.<br>보면 <code>event</code> 에도 <code>context</code>가 존재하는데 여기에 <code>stage</code> property가 있고 우리가 deploy했던 stage를 참조할 수 있는데 이를 통해 (프로덕션 코드와 개발코드가 분리되는데 맞지만) lambda 함수에서 개발 버전 또는 배포 버전의 일에 대해 분기를 할 수 있게 된다.</p><h2><span id="travis-ci를-통한-배포-자동화">travis ci를 통한 배포 자동화</span></h2><p>code로 대신한다.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">- provider:</span> <span class="string">lambda</span></span><br><span class="line"><span class="attr">  function_name:</span> <span class="string">loopbackArgument</span></span><br><span class="line"><span class="attr">  role:</span> <span class="attr">arn:aws:iam::...</span></span><br><span class="line"><span class="attr">  handler_name:</span> <span class="string">handler</span></span><br><span class="line"><span class="attr">  region:</span> <span class="string">ap-northeast-2</span></span><br><span class="line"><span class="attr">  access_key_id:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">  secret_access_key:</span></span><br><span class="line"><span class="attr">    secure:</span> <span class="string">...</span></span><br><span class="line"><span class="attr">  runtime:</span> <span class="string">nodejs4.3</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure><p>조금 부연하자면</p><ul><li><code>role</code>은 lambda함수를 생성할 때 줬던 role(lambda 함수 실행을 위한) 이 들어가야된다.</li><li>추가적으로 메모리 사용량 설정등도 가능하다.</li><li>s3를 통해 업로드하는 방식과 달리 폴더를 압축해서 zip파일을 업로드하게 되는데 이때 용량제한이 걸린다. 압축한 파일을 용량이 <code>50MB</code>를 넘어가면 deploy에 실패하게 되니 주의하자.<ul><li>이 때는 s3에 upload 하고 추가로 스크립팅을 통해 deploy 되야하므로 번거로워진다.</li></ul></li></ul><h2><span id="next">next</span></h2><blockquote><p>실무 적용 및 효율 적인 업무를 위한 추가 적인 작업들은 아래와 같다.</p></blockquote><p>todo</p><ul><li>custom domain을 통한 배포<ul><li>ssl 적용</li></ul></li><li>api gateway<ul><li>cors 적용</li></ul></li><li>swagger를 통한 문서화 및 배포</li><li>slack을 통한 알림 처리</li></ul></div><div class="article-tags"><a class="tag-link" href="../../../tags/api-gateway/">api gateway</a><a class="tag-link" href="../../../tags/aws/">aws</a><a class="tag-link" href="../../../tags/ci/">ci</a><a class="tag-link" href="../../../tags/lambda/">lambda</a><a class="tag-link" href="../../../tags/lambda-배포/">lambda 배포</a><a class="tag-link" href="../../../tags/travis/">travis</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="http://blog.bglee.me">봉로그</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars1.githubusercontent.com/u/1223020?s=400&u=c3a99ef61b76bff024adc28d0c884265fbea98a0&v=4"></div><div class="info"><a class="name dark-btn" href="../../../index.htmlabout">deptno@gmail.com</a></div><div class="info"><span class="item desc">주섬주섬...</span></div></div><div class="social clearfix"><a href="https://medium.com/feed/@deptno" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:deptno@gmail.com" class="mail" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/deptno" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://twitter.com/deptno" class="twitter" target="_blank" rel="external"><span class="icon icon-twitter"></span> </a><a href="https://plus.google.com/u/0/+이봉균" class="google" target="_blank" rel="external"><span class="icon icon-google"></span> </a><a href="https://www.facebook.com/bonggyun.lee.7" class="facebook" target="_blank" rel="external"><span class="icon icon-facebook"></span> </a><a href="https://www.linkedin.com/in/bonggyun-lee-b55359b3/" class="linkedin" target="_blank" rel="external"><span class="icon icon-linkedin"></span> </a><a href="https://www.instagram.com/deptno/" class="instagram" target="_blank" rel="external"><span class="icon icon-instagram"></span> </a><a href="../../../atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="../../../js/search.js"></script><script src="../../../js/app.js"></script><script type="text/javascript">var disqus_shortname="deptno",disqus_url="http://blog.bglee.me/posts/2016/aws-gateway-lambda-ci/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>