<!DOCTYPE html><html><head><meta charset="utf-8"><title>Github OAuth 404, 그리고 헤더의 중요성 | 봉로그</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="이 것도 한 3번인가 삽질을 한 것 같은데.. 기록을 해두지 않아 매번 삽질을 한다. 오늘도 4시간 정도 날린거같다…3 티어 인증 프로세스클라이언트(웹)에서 깃헙로 리다이렉션을 시도한다.깃헙에서는 스코프랑 유저 허락 받고 허락 되면 어플리케이션 정보 저장시에 사용했던 콜백(서버)로 code 를 전송한다.서버는 code 를 token 으로 교환한다.교환 후에"><meta name="keywords" content="github,OAuth,login,깃허브,로그인,404"><meta property="og:type" content="article"><meta property="og:title" content="Github OAuth 404, 그리고 헤더의 중요성"><meta property="og:url" content="http://blog.bglee.me/posts/2018/Github-OAuth-404/index.html"><meta property="og:site_name" content="봉로그"><meta property="og:description" content="이 것도 한 3번인가 삽질을 한 것 같은데.. 기록을 해두지 않아 매번 삽질을 한다. 오늘도 4시간 정도 날린거같다…3 티어 인증 프로세스클라이언트(웹)에서 깃헙로 리다이렉션을 시도한다.깃헙에서는 스코프랑 유저 허락 받고 허락 되면 어플리케이션 정보 저장시에 사용했던 콜백(서버)로 code 를 전송한다.서버는 code 를 token 으로 교환한다.교환 후에"><meta property="og:locale" content="ko"><meta property="og:updated_time" content="2018-08-07T12:14:31.970Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Github OAuth 404, 그리고 헤더의 중요성"><meta name="twitter:description" content="이 것도 한 3번인가 삽질을 한 것 같은데.. 기록을 해두지 않아 매번 삽질을 한다. 오늘도 4시간 정도 날린거같다…3 티어 인증 프로세스클라이언트(웹)에서 깃헙로 리다이렉션을 시도한다.깃헙에서는 스코프랑 유저 허락 받고 허락 되면 어플리케이션 정보 저장시에 사용했던 콜백(서버)로 code 를 전송한다.서버는 code 를 token 으로 교환한다.교환 후에"><link rel="icon" href="../../../favicon.png"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74859643-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-74859643-1")</script><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="../../../icomoon/style.css"><link rel="stylesheet" href="../../../style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="../../../index.html"><span class="b">봉 </span><span class="b">로 </span><span class="b">그 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-Github-OAuth-404" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">Github OAuth 404, 그리고 헤더의 중요성</h1><div class="article-meta">Posted on <time class="article-time" datetime="2018-08-07T11:32:50.000Z" itemprop="datePublished">8월 7, 2018</time></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p>이 것도 한 3번인가 삽질을 한 것 같은데.. 기록을 해두지 않아 매번 삽질을 한다. 오늘도 4시간 정도 날린거같다…</p></blockquote><h2><span id="3-티어-인증-프로세스">3 티어 인증 프로세스</span></h2><ul><li>클라이언트(웹)에서 깃헙로 리다이렉션을 시도한다.</li><li>깃헙에서는 스코프랑 유저 허락 받고 허락 되면 어플리케이션 정보 저장시에 사용했던 콜백(서버)로 <strong>code</strong> 를 전송한다.</li><li>서버는 <strong>code</strong> 를 <strong>token</strong> 으로 교환한다.</li><li>교환 후에는 <strong>token</strong> 을 가지고 다시 클라이언트로 돌아갈 수 있도록 <strong>302</strong> 리턴을 하면서 쿼리 파라메터로 <strong>token</strong> 을 넘긴다.</li></ul><h2><span id="이슈">이슈</span></h2><p>코드에서 토큰으로 교환하는 과정에서 깃헙이 <strong>404</strong> 를 내뱉는다. 무엇이 문제인가 <span class="github-emoji" title="eyes" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f440.png?v8">&#x1f440;</span></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">`https://github.com/login/oauth/access_token`</span>, &#123;</span><br><span class="line">  method: <span class="string">'POST'</span>,</span><br><span class="line">  body: &#123;</span><br><span class="line">    client_id    : GITHUB_CLIENT_ID,</span><br><span class="line">    client_secret: GITHUB_CLIENT_SECRET,</span><br><span class="line">    code,</span><br><span class="line">    <span class="comment">// state,</span></span><br><span class="line">    <span class="comment">// redirect_uri</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3><span id="content-type-헤더의-중요성">Content-Type 헤더의 중요성</span></h3><p>문제는 이것 저것 해보다가 설마 헤더 때문인가? 라는 생각에 이르렀다. 코드는 다음과 같이 수정해봤다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">`https://github.com/login/oauth/access_token`</span>, &#123;</span><br><span class="line">  method: <span class="string">'POST'</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  body: &#123;</span><br><span class="line">    client_id    : GITHUB_CLIENT_ID,</span><br><span class="line">    client_secret: GITHUB_CLIENT_SECRET,</span><br><span class="line">    code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>바로 <strong>200 OK</strong> 가 떨어진다. <span class="github-emoji" title="fist_raised" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/270a.png?v8">&#x270a;</span></p><h3><span id="서버는-서버-엔지니어-마음">서버는 서버 엔지니어 마음</span></h3><p>언젠가는 URL에 뒤에 <code>/</code> 를 붙이냐 마느냐로, <code>200</code> vs <code>201</code>, <code>200</code> vs <code>404</code> 등등 피곤하고 시나리오적인 흐름과 주관이 섞일 수 밖에 없는 문제가 있다.</p><p>소 제목은 <strong>서버는 서버 엔지니어 마음이다.</strong> 라고 달았지만 흥분을 가라 앉히고 보면 내가 잘못한게 맞다. 이런 날들을 위해 준비되어있는 스펙을 무시했다. 최근 근무한 직장도 그렇고 기본적으로 <code>JSON</code> 이 일반화 된 세상에서 살고 있다보니 기본이 <code>JSON</code> 일 것이라 예단했다. 깃헙도 꽤나 오랜 시간을 버텨왔고 매우 많은 유저가 사용하는 만큼 바꾸지 못하는 레거시가 있기 마련이다.</p><h2><span id="리턴-값">리턴 값</span></h2><p>자성을 하고 리턴 값을 확인하려고 코드를 짜니 또 에러가 난다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> json = <span class="keyword">await</span> response.json()</span><br></pre></td></tr></table></figure><p>고통을 교훈으로 헤더를 확인했다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">'content-type'</span>: [ <span class="string">'application/x-www-form-urlencoded; charset=utf-8'</span> ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>두번 반성한다. 리턴값도 당연히 <code>JSON</code> 일리가 없었다. <code>response.text()</code> 도 가능하지만 요청 헤더에 <code>Accept</code> 를 추가했다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 잘 날아온다. <span class="github-emoji" title="boxing_glove" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f94a.png?v8">&#x1f94a;</span></p><h2><span id="다시-한번-헤더의-중요성-다시-한번-서버는-서버-엔지니어의-마음">다시 한번 헤더의 중요성, 다시 한번 서버는 서버 엔지니어의 마음</span></h2><p><strong>API</strong> 를 사용하다보면 헤더도 마음데로 들어온다. 서버리스의 <strong>serverless offline</strong> 플러그인을 통하면 <code>event.headers.referer</code> 가 들어오는데 반해 실제 서버에 디플로이되면 <code>event.headers.Referer</code> 가 들어온다. 이 경우는 플러그인 버그라 할 수 있겠지만 대소문자도 예단해선 안된다.</p></div><div class="article-tags"><a class="tag-link" href="../../../tags/404/">404</a><a class="tag-link" href="../../../tags/OAuth/">OAuth</a><a class="tag-link" href="../../../tags/github/">github</a><a class="tag-link" href="../../../tags/login/">login</a><a class="tag-link" href="../../../tags/깃허브/">깃허브</a><a class="tag-link" href="../../../tags/로그인/">로그인</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="http://blog.bglee.me">봉로그</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars1.githubusercontent.com/u/1223020?s=400&u=c3a99ef61b76bff024adc28d0c884265fbea98a0&v=4"></div><div class="info"><a class="name dark-btn" href="../../../index.htmlabout">deptno@gmail.com</a></div><div class="info"><span class="item desc">코드를 넘어</span></div></div><div class="social clearfix"><a href="https://medium.com/feed/@deptno" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:deptno@gmail.com" class="mail" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/deptno" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://twitter.com/deptno" class="twitter" target="_blank" rel="external"><span class="icon icon-twitter"></span> </a><a href="https://plus.google.com/u/0/+이봉균" class="google" target="_blank" rel="external"><span class="icon icon-google"></span> </a><a href="https://www.facebook.com/bonggyun.lee.7" class="facebook" target="_blank" rel="external"><span class="icon icon-facebook"></span> </a><a href="https://www.linkedin.com/in/bonggyun-lee-b55359b3/" class="linkedin" target="_blank" rel="external"><span class="icon icon-linkedin"></span> </a><a href="https://www.instagram.com/deptno/" class="instagram" target="_blank" rel="external"><span class="icon icon-instagram"></span> </a><a href="../../../atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="../../../js/search.js"></script><script src="../../../js/app.js"></script><script type="text/javascript">var disqus_shortname="deptno",disqus_url="http://blog.bglee.me/posts/2018/Github-OAuth-404/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>