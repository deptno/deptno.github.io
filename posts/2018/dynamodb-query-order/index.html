<!DOCTYPE html><html><head><meta charset="utf-8"><title>AWS 다이나모디비 정렬 | 봉로그</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="AWS DynamoDB query order미션 전체 데이터를 최근순으로 가져온다. &amp;#x1f40f;다이나모디비의 키 구성다이나모디비는 필수적인 해시키와 추가적으로 정렬키를 할당해서 기본키를 이룰 수 있다.Scan vs Query스캔은 모든 항목을 읽어온다. 그 중간에 필터를 걸어서 원하는 것 만을 뽑아 올 수 있지만 기본적으로 모든 다큐먼트(레코드)를 검"><meta name="keywords" content="aws,dynamodb,query,orderby,order"><meta property="og:type" content="article"><meta property="og:title" content="AWS 다이나모디비 정렬"><meta property="og:url" content="http://blog.bglee.me/posts/2018/dynamodb-query-order/index.html"><meta property="og:site_name" content="봉로그"><meta property="og:description" content="AWS DynamoDB query order미션 전체 데이터를 최근순으로 가져온다. &amp;#x1f40f;다이나모디비의 키 구성다이나모디비는 필수적인 해시키와 추가적으로 정렬키를 할당해서 기본키를 이룰 수 있다.Scan vs Query스캔은 모든 항목을 읽어온다. 그 중간에 필터를 걸어서 원하는 것 만을 뽑아 올 수 있지만 기본적으로 모든 다큐먼트(레코드)를 검"><meta property="og:locale" content="ko"><meta property="og:image" content="http://blog.bglee.me/posts/2018/dynamodb-query-order/create-gsi.png"><meta property="og:updated_time" content="2018-08-28T10:15:38.856Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AWS 다이나모디비 정렬"><meta name="twitter:description" content="AWS DynamoDB query order미션 전체 데이터를 최근순으로 가져온다. &amp;#x1f40f;다이나모디비의 키 구성다이나모디비는 필수적인 해시키와 추가적으로 정렬키를 할당해서 기본키를 이룰 수 있다.Scan vs Query스캔은 모든 항목을 읽어온다. 그 중간에 필터를 걸어서 원하는 것 만을 뽑아 올 수 있지만 기본적으로 모든 다큐먼트(레코드)를 검"><meta name="twitter:image" content="http://blog.bglee.me/posts/2018/dynamodb-query-order/create-gsi.png"><link rel="icon" href="../../../favicon.png"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74859643-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-74859643-1")</script><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="../../../icomoon/style.css"><link rel="stylesheet" href="../../../style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="../../../index.html"><span class="b">봉 </span><span class="b">로 </span><span class="b">그 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-dynamodb-query-order" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">AWS 다이나모디비 정렬</h1><div class="article-meta">Posted on <time class="article-time" datetime="2018-08-28T10:15:38.000Z" itemprop="datePublished">8월 28, 2018</time></div></header><div class="article-entry" itemprop="articleBody"><h2><span id="aws-dynamodb-query-order">AWS DynamoDB query order</span></h2><blockquote><p><strong>미션</strong> 전체 데이터를 최근순으로 가져온다. <span class="github-emoji" title="ram" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f40f.png?v8">&#x1f40f;</span></p></blockquote><h4><span id="다이나모디비의-키-구성">다이나모디비의 키 구성</span></h4><p>다이나모디비는 필수적인 해시키와 추가적으로 정렬키를 할당해서 기본키를 이룰 수 있다.</p><h4><span id="scan-vs-query">Scan vs Query</span></h4><p>스캔은 모든 항목을 읽어온다. 그 중간에 필터를 걸어서 원하는 것 만을 뽑아 올 수 있지만 기본적으로 모든 다큐먼트(레코드)를 검색하기에 그만큼의 비용이 소모된다.</p><p>필터는 가능하지만 <strong>정렬</strong>은 가능하지 않ㄴ다.</p><h3><span id="query">Query</span></h3><p>때문에 정렬을 위해서는 Query를 통해서 데이터를 가져와한다. 쿼리는 기본인자로 해시키를 받는다. 정렬은 정렬키를 통해서 이루어지는데 해시키를 주게되면 데이터셋이 한정되므로 <strong>데이터 전체</strong>에 대한 정렬을 원하는 내게 원하는 동작은 아니다.</p><p>때문에 이를 위해선 꽤 번거로운 작업을 필요로 한다. 내가 찾은 방법은 <strong>GSI</strong>를 이용하는 방법이다. 인덱스의 형식에는 GSI와 LSI가 존재한다.</p><h4><span id="global-secondary-indexgsi-vs-local-secondary-indexlsi">Global Secondary Index(GSI) vs Local Secondary Index(LSI)</span></h4><p>GSI와 LSI의 차이는 기본적으로 해시키를 테이블 정의시의 해시키를 그대로 활용하고 정렬키만 바꾸는가 아니면 해시키까지 다시 정의하는 가에 대한 차이가 있다.</p><h3><span id="query-x1f46d-gsi">Query <span class="github-emoji" title="two_women_holding_hands" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f46d.png?v8">&#x1f46d;</span> GSI</span></h3><p>다시 쿼리로 돌아와서 미션을 해결하고자 GSI를 생성했다. 쿼리에서는 기본적으로 해쉬키를 건내야한다. 쿼리를 날리기 위한 데이터셋을 정의하는 행동인데 전체로하므로 어글리하게도 상수 값을 속성하나에 할당하기로 한다. 예를들어 <code>sort</code> 라는 속성을 해시키로 할당하고 모든 도큐먼트(record)에 대해서 동일한 값을 줘서 전체를 데이터셋으로 만드는 내용이다.</p><h4><span id="gsi-생성">GSI 생성</span></h4><p><img src="create-gsi.png" alt="create-gsi"></p><p>그럼 GSI를 생성하기 위해 다이나모 테이블에서 <strong>인덱스</strong>를 선택하고 GSI를 생성한다. 해쉬값에는 위에서 얘기한데로 <code>sort</code>라는 이름을 주고 타입을 <code>번호</code>로 설정했다. 바이너리로 설정하니 <code>aws-sdk</code>의 <code>DynamoDBClient</code> 에서 접근하기가 어려웠다.</p><p>정렬키에는 정렬의 기준이 되고자 하는 속성을 선택해야한다. <code>createAt</code> 등등 사용하고 있는 이름이 있을거다. 난 <code>date</code> 였다. 때문에 <code>date</code> 를 넣고 그에 맞는 속성을 줬다. 난 <code>번호</code> 였다.</p><p>생성에는 5분정도 시간이 걸렸던 것 같다. 기존 데이터의 양과 프로비저닝된 용량에 따라 시간이 더 소모될 수 있다.</p><p>인덱스의 이름은 편할 걸 넣어주면된다. 아래서 작성 할 코드에서는 <strong>PascalCase</strong> 형식으로 이름을 작성했다.</p><h4><span id="데이터를-추가">데이터를 추가</span></h4><p>데이터를 추가할때 <code>sort: 0</code> 이 반드시 추가되야한다. 그래야지만 인덱싱이 가능하다. <code>0</code>은 우리가 <code>번호</code> 타입을 설정했고 모든 데이터를 묶기 위해 동일한 숫자로 선택했을 뿐 다른 의미는 없다.</p><p>기존 데이터들이 있다라면 모두 업데이트를 쳐줘야한다. <span class="github-emoji" title="cloud_with_lightning_and_rain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/26c8.png?v8">&#x26c8;</span></p><h4><span id="code">Code</span></h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> AWS <span class="keyword">from</span> <span class="string">'aws-sdk'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> EDyanmoDBTable &#123;</span><br><span class="line">  User    = <span class="string">'User'</span>,</span><br><span class="line">  Post    = <span class="string">'Post'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> EDyanmoDBGSI &#123;</span><br><span class="line">  SortDate = <span class="string">'SortDate'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ddbClient = <span class="keyword">new</span> AWS.DynamoDB.DocumentClient()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> queryPosts = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ddbClient</span><br><span class="line">    .query(&#123;</span><br><span class="line">      TableName: EDyanmoDBTable.Post,</span><br><span class="line">      IndexName: EDyanmoDBGSI.SortDate,</span><br><span class="line">      ScanIndexForward: <span class="literal">false</span>,</span><br><span class="line">      KeyConditionExpression: <span class="string">"#sort = :sort"</span>,</span><br><span class="line">      ExpressionAttributeNames: &#123;</span><br><span class="line">        <span class="string">"#sort"</span>: <span class="string">"sort"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      ExpressionAttributeValues: &#123;</span><br><span class="line">        <span class="string">":sort"</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    .promise()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5><span id="scanindexforward">ScanIndexForward</span></h5><p>이 파라메터를 통해 오름차순(<code>true</code> default)과 내림차순(<code>false</code>)이 결정된다. 정렬은 정렬키를 통해서 이루어지므로 코드에는 명시되지 않았지만 <code>IndexName</code> 을 통해 <code>date</code> 정렬키를 보유한 인덱스를 가리키고 있다.</p><h3><span id="x26a0-주의할-점"><span class="github-emoji" title="warning" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/26a0.png?v8">&#x26a0;</span> 주의할 점</span></h3><p>테이블이 생성되었고 GSI를 생성하기 전에 <code>sort: number</code> 형식으로 데이터를 이미 생성했다고 가정해보자. 아무래도 <code>DynamoDBClient</code> 의 <code>put</code>을 통하면 <code>Binary</code> 형식 입력이 되지 않는 것으로 보이는데 때문에 <code>sort: number</code> 가 도큐먼트에 들어간 상태에서 GSI를 <code>sort: binary</code> 형식으로 생성하게 되면 이 데이터들이 인덱싱이 되지 않는다.</p><p>또한 더 골때리는 것은 애매 모호한 에러를 내면서 <code>query</code> 도 동작하지 않으니 주의하자.</p><hr><p><span class="github-emoji" title="information_desk_person" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f481.png?v8">&#x1f481;</span> 말을 다소 혼용해서 했는데 <code>number</code> 는 번호, <code>binary</code> 는 이진수를 의미한다.</p></div><div class="article-tags"><a class="tag-link" href="../../../tags/aws/">aws</a><a class="tag-link" href="../../../tags/dynamodb/">dynamodb</a><a class="tag-link" href="../../../tags/order/">order</a><a class="tag-link" href="../../../tags/orderby/">orderby</a><a class="tag-link" href="../../../tags/query/">query</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="http://blog.bglee.me">봉로그</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars1.githubusercontent.com/u/1223020?s=400&u=c3a99ef61b76bff024adc28d0c884265fbea98a0&v=4"></div><div class="info"><a class="name dark-btn" href="../../../index.htmlabout">deptno@gmail.com</a></div><div class="info"><span class="item desc">코드를 넘어</span></div></div><div class="social clearfix"><a href="https://medium.com/feed/@deptno" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:deptno@gmail.com" class="mail" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/deptno" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://twitter.com/deptno" class="twitter" target="_blank" rel="external"><span class="icon icon-twitter"></span> </a><a href="https://plus.google.com/u/0/+이봉균" class="google" target="_blank" rel="external"><span class="icon icon-google"></span> </a><a href="https://www.facebook.com/bonggyun.lee.7" class="facebook" target="_blank" rel="external"><span class="icon icon-facebook"></span> </a><a href="https://www.linkedin.com/in/bonggyun-lee-b55359b3/" class="linkedin" target="_blank" rel="external"><span class="icon icon-linkedin"></span> </a><a href="https://www.instagram.com/deptno/" class="instagram" target="_blank" rel="external"><span class="icon icon-instagram"></span> </a><a href="../../../atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="../../../js/search.js"></script><script src="../../../js/app.js"></script><script type="text/javascript">var disqus_shortname="deptno",disqus_url="http://blog.bglee.me/posts/2018/dynamodb-query-order/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>