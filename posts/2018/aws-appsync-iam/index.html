<!DOCTYPE html><html><head><meta charset="utf-8"><title>AWS AppSync, Amplify를 이용한 IAM 롤 기반의 풀스택 GraphQL 프로젝트 구현 | 봉로그</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="&amp;#x1f508; 진행 과정의 원할함을 위해 프로젝트 명은 deptno 로 가정한다.&amp;#x1f508; IAM 을 통한 비인증 유저의 AppSync GraphQL 접근을 목표로 한다.서론😭 이 글은 눈물로 작성되었다. 눈물없이 가능하지 않았던 처절한 삽질을 말끔히 정리하고자 한다.인증은 매우 복잡하면서도 중요한 파트로 여러가지 방식이 존재하고 일단 설정하면"><meta name="keywords" content="aws,cognito,dynamodb,amplify,unauthenticated,iam,role,graphql"><meta property="og:type" content="article"><meta property="og:title" content="AWS AppSync, Amplify를 이용한 IAM 롤 기반의 풀스택 GraphQL 프로젝트 구현"><meta property="og:url" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/index.html"><meta property="og:site_name" content="봉로그"><meta property="og:description" content="&amp;#x1f508; 진행 과정의 원할함을 위해 프로젝트 명은 deptno 로 가정한다.&amp;#x1f508; IAM 을 통한 비인증 유저의 AppSync GraphQL 접근을 목표로 한다.서론😭 이 글은 눈물로 작성되었다. 눈물없이 가능하지 않았던 처절한 삽질을 말끔히 정리하고자 한다.인증은 매우 복잡하면서도 중요한 파트로 여러가지 방식이 존재하고 일단 설정하면"><meta property="og:locale" content="ko"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/password-policy.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/aws-appsync-iam/create-app-client.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/create-policy.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/appsync-create-api.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/aws-appsync-iam/appsync-api-type.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/dynamodb-create-table.png"><meta property="og:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/appsync-datasource-setting.png"><meta property="og:updated_time" content="2018-08-18T04:23:19.912Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AWS AppSync, Amplify를 이용한 IAM 롤 기반의 풀스택 GraphQL 프로젝트 구현"><meta name="twitter:description" content="&amp;#x1f508; 진행 과정의 원할함을 위해 프로젝트 명은 deptno 로 가정한다.&amp;#x1f508; IAM 을 통한 비인증 유저의 AppSync GraphQL 접근을 목표로 한다.서론😭 이 글은 눈물로 작성되었다. 눈물없이 가능하지 않았던 처절한 삽질을 말끔히 정리하고자 한다.인증은 매우 복잡하면서도 중요한 파트로 여러가지 방식이 존재하고 일단 설정하면"><meta name="twitter:image" content="http://blog.bglee.me/posts/2018/aws-appsync-iam/password-policy.png"><link rel="icon" href="../../../favicon.png"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-74859643-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-74859643-1")</script><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="../../../icomoon/style.css"><link rel="stylesheet" href="../../../style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="../../../index.html"><span class="b">봉 </span><span class="b">로 </span><span class="b">그 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-aws-appsync-iam" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">AWS AppSync, Amplify를 이용한 IAM 롤 기반의 풀스택 GraphQL 프로젝트 구현</h1><div class="article-meta">Posted on <time class="article-time" datetime="2018-08-18T04:13:02.000Z" itemprop="datePublished">8월 18, 2018</time></div></header><div class="article-entry" itemprop="articleBody"><blockquote><p><span class="github-emoji" title="speaker" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f508.png?v8">&#x1f508;</span> 진행 과정의 원할함을 위해 프로젝트 명은 <code>deptno</code> 로 가정한다.</p></blockquote><blockquote><p><span class="github-emoji" title="speaker" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f508.png?v8">&#x1f508;</span> IAM 을 통한 비인증 유저의 AppSync GraphQL 접근을 목표로 한다.</p></blockquote><h2><span id="서론">서론</span></h2><blockquote><p>😭 이 글은 눈물로 작성되었다. 눈물없이 가능하지 않았던 처절한 삽질을 말끔히 정리하고자 한다.</p></blockquote><p>인증은 매우 복잡하면서도 중요한 파트로 여러가지 방식이 존재하고 일단 설정하면 바꾸기 어렵다. 때문에 시행착오를 통합 삽질을 하기에도 매우 두려운 부분이다. 그래서 명확히 이해 해야만 했고 거의 그럴뻔 했으나 만들어진 코드나 매우 소중이 다루자는 결론에 이르렀다?</p><p><strong>react-apollo</strong> 와 같이 표준에 가까운 라이브러리 들이 있지만 여기선 <code>aws-amplify</code> 에서 제공하는 최소한만을 사용했다. AWS의 코드 샘플 자체가 <strong>react-apollo</strong> 기준이라 이 편이 더 도움이 될 거라 생각했다. 타 서비스도 GraphQL 를 사용해서 엔드포인트가 두개가 될 경우 골치아파지는데 그런 경우에 대응하기 위한 점도 고려됐다.</p><p>글은 프로젝트와 함께 진행된다. 이 프로젝트는 <strong>AWS AppSync, Cognito, Amplify, DynamoDB</strong> 를 통해 <strong>비인증</strong> 유저에게 <strong>Graph QL</strong> API 콜을 통한 데이터를 제공한다. 추가적으로 인증 유저에게 다른 권한을 부여하기 위함이다. 이 부분은 나중에 풀어보겠다. 아마도 이 길인 것 같아서 선택했다. <span class="github-emoji" title="cherry_blossom" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f338.png?v8">&#x1f338;</span></p><p>프론트엔드 프로젝트와 함께 설정값을 넣으면서 그때 그때 필요한 AWS 리소스를 생성해가면서 진행하도록 한다. 때문에 진행은 프론트엔드와 AWS가 함께 진행된다. <code>configure.js</code> 파일을 채워나가면서 진행해보자.</p><p>동작에 대한 궁금증은 마지막 프론트엔드 프로젝트를 구현하면서 우리가 해왔던 것들이 어떤 영향을 갖는지 최대한 설명 해보겠다.</p><h2><span id="aws-amplify-설정">AWS Amplify 설정</span></h2><h3><span id="설치">설치</span></h3><p>프로젝트 디렉토리에 진입해서 <code>aws-amplify</code>패키지를 설치한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add aws-amplify</span><br></pre></td></tr></table></figure><p>프로젝트의 원활한 진행을 위해 내가 자주쓰는 <strong>Next.jS</strong> 를 기준으로 작성하겠다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add next</span><br></pre></td></tr></table></figure><h3><span id="설정">설정</span></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch configure.js</span><br></pre></td></tr></table></figure><p>설정 파일을 만들고 다음과 같은 코드를 삽입한다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// configure.js</span></span><br><span class="line"><span class="keyword">import</span> Amplify <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"></span><br><span class="line">Amplify.configure(&#123;</span><br><span class="line">    Auth: &#123;</span><br><span class="line">        identityPoolId: <span class="string">'XX-XXXX-X:XXXXXXXX-XXXX-1234-abcd-1234567890ab'</span>, </span><br><span class="line">        region: <span class="string">'XX-XXXX-X'</span>, </span><br><span class="line">        userPoolId: <span class="string">'XX-XXXX-X_abcd1234'</span>,</span><br><span class="line">        userPoolWebClientId: <span class="string">'XX-XXXX-X_abcd1234'</span>, </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>설정에 입력된 바와 같이 4가지 필요하다.</p><ul><li>identityPoolId - <strong>코그니토 연동 자격</strong> 증명에 대한 풀 ID</li><li>region - 서울이라면 <strong>‘ap-northeast-2’</strong></li><li>userPoolId: - <strong>코그니토 유저 풀</strong> ID</li><li>userPoolWebClientId - 코그니토 유저 풀 생성 후 <strong>앱 클라이언트 설정</strong> 에서 <strong>시크릿 키 체크 해제</strong> 후 생성된 ID</li></ul><h3><span id="cognito-설정">Cognito 설정</span></h3><p>먼저 유저풀을 생성한다.</p><h4><span id="코그니토-유저-풀-생성optional">코그니토 유저 풀 생성(Optional)</span></h4><p><a href="https://ap-northeast-2.console.aws.amazon.com/cognito/users" target="_blank" rel="noopener">https://ap-northeast-2.console.aws.amazon.com/cognito/users</a> 에 접속 후 <strong>사용자 풀 생성</strong> 버튼을 클릭한다.</p><p><code>Dev Deptno User Pool</code> 를 입력하고 기본값 검토를 누른다.</p><p>정책 &gt; 암호 강도에서 체크박스를 모두 해제하고 자릿수를 6으로 설정한다.</p><p><img src="password-policy.png" alt="password-policy"></p><p>앱 클라이언트 &gt; 클라이언트를 추가하되 <strong>클라이언트 보안키 생성</strong> 을 해제한다. 이름은 <code>Dev Deptno Web Client</code> 로 했다.<img src="aws-appsync-iam/create-app-client.png" alt="create-app-client"></p><p>다시 <strong>검토</strong> 로 이동해서 <strong>풀 생성</strong> 버튼을 누른다.</p><p>이전 <strong>설정</strong> 에서 만들었던 <code>configure.js</code> 에서 <code>userPoolId</code> 를 풀 생성 후 나오는 <strong>풀 ID</strong> 로 교체한다. <strong>앱 클라이언트 설정</strong> 으로 이동해서 클라이언트 ID 를 <code>userPoolWebClientId</code> 에 입력한다.</p><h4><span id="코그니토-자격-증명-풀-생성required">코그니토 자격 증명 풀 생성(Required)</span></h4><p><code>Dev Deptno Identity Pool</code> 이름을 지정하고 <strong>인증되지 않은 자격 증명에 대한 액세스 활성화</strong> 를 <strong>체크</strong> 한다.</p><p>인증 공급자에서 <code>Cognito</code> 탭에 <code>configure</code> 에 입력한 <code>userPoolId</code> 와 <code>userPoolWebClientId</code> 를 순서대로 입력한다.</p><p><strong>풀 생성</strong> 버튼을 눌러 풀을 생성한다. IAM 설정이 나오는데 <strong>허용 </strong>을 눌러서 인증, 비인증 유저에 대한 롤을 생성한다. 추가 후 나오는 자격 증명 풀 ID 를 <code>configure.js</code> 의 <code>identityPoolId</code> 에 넣는다.</p><h5><span id="iam-role-설정">IAM Role 설정</span></h5><p>코그니토 자격 증명 풀을 생성할 때 인증되지 않은 자격 증명에 대한 액세스를 활성화 했다. 이때 미인증에 대한 <code>IAM ROLE</code> 도 함께 생성했는데 <strong>Cognito Sync</strong> 가 <strong>AppSync</strong> 로 대체되면서 정책 설정이 제대로 않아 <code>401</code> 에러가 발생한다.</p><p>이를 해결하기 위해 <strong>IAM &gt; 역할</strong> 로 가면 역할을 이름을 변경하지 않고 그대로 갔다라면 <code>Cognito_DevDeptnoIdentityPoolUnauth_Role</code> 형식의 이름으로 역할이 존재한다. 이를 선택하고 <strong>인라인 정책 &gt; JSON</strong> 을 선택하고 아래 데이터를 붙여넣는다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"appsync:GraphQL"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 역할을 생성한다. 아래와 같은 형식으로 이름을 넣어주면 보기 편하겠다.</p><p><img src="create-policy.png" alt="create-policy"></p><p>역할을 생성하고 정책이 연결됬으면 미인증 유저의 GraphQL 엔드포인트에 대한 접근이 허가된다.</p><hr><h2><span id="appsync">AppSync</span></h2><p><strong>AppSync</strong> 는 아직 서울 리전이 지원되지 않는다. 때문에 우린 도쿄로 간다.</p><blockquote><p><span class="github-emoji" title="cloud_with_lightning_and_rain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/26c8.png?v8">&#x26c8;</span> awsmobile cli 커맨드를 통해 생성하면 GraphQL 엔드포인트가 ap-northeast-2(서울) 로 설정파일이 생성되지만 서울 리전에는 아직 <strong>AppSync</strong> 가 존재 하지 않는다. 템플릿 예외 처리 오류로 보인다.</p></blockquote><p><a href="https://ap-northeast-1.console.aws.amazon.com/appsync/home?region=ap-northeast-1#/create" target="_blank" rel="noopener">https://ap-northeast-1.console.aws.amazon.com/appsync/home?region=ap-northeast-1#/create</a> AWS 콘솔에서 <strong>AppSync</strong> 를 선택하고 <strong>Create API</strong> 를 누른다. 템플릿이 몇개 주어지는데 <strong>Author from scratch</strong> 를 선택해서 깔끔하게 시작한다.</p><p><img src="appsync-create-api.png" alt="appsync-create-api"></p><p>이름은 <code>Dev Deptno GraphQL</code> 정도면 멋진것 같다.</p><p><strong>Settings</strong> 섹션으로 이동하면 인증 타입을 선택할 수 있다.<img src="aws-appsync-iam/appsync-api-type.png" alt="appsync-api-type"></p><p>기본은 <strong>API key</strong> 다 헤더에 추가만 해주면 동작하므로 매우 간편한 방식이다. 우리는 <strong>AWS Identity and Access Management</strong> 를 선택한다.</p><p>이제 클라이언트에서 콜을 할때 가지고 있는 인증 권한에 따라 API 가 제한되게된다.</p><h3><span id="dynamodb-설정">DynamoDB 설정</span></h3><blockquote><p><span class="github-emoji" title="speaker" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f508.png?v8">&#x1f508;</span> <strong>AppSync</strong> 가 서울에서 지원이 안되다보니 서비스를 이동하다보면 리전이 꼬일 수 있다. 나머지 리소스는 서울임을 계속 확인하는 것이 좋다.</p></blockquote><p><strong>AppSync</strong> 가 데이터를 퍼다 나르기 위해서 데이터 소스를 연결해야하는데 이 프로젝트에서는 다이나모디비를 이용한다. AWS 콘솔에서 <strong>DynamoDB</strong> 를 선택한다.</p><p><strong>테이블</strong> 섹션에서 <strong>테이블 만들기</strong> 를 누르고 이름이랑 키만 설정하면 바로 테이블이 생성된다.(어썸..👍)</p><p><img src="dynamodb-create-table.png" alt="dynamodb-create-table"></p><p>파티션 키는 <strong>email</strong> 이라고 쓰고 대충 생성을 하자. 테이블 이름은 <code>Dev Deptno User</code> 로 한다.</p><blockquote><p><span class="github-emoji" title="thinking" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f914.png?v8">&#x1f914;</span> 테이블 이름은 단수로 해야 GraphQL 스키마 자동생성을 할 때 깔끔하게 맞는 느낌이 있다..</p></blockquote><h3><span id="data-source-추가">Data Source 추가</span></h3><p>다시 AWS 콘솔에서 <strong>AppSync</strong> 로 돌아온 뒤 <strong>Data Source</strong> 섹션을 선택하고 새로운 소스를 추가하기 위해 <strong>New</strong> 를 누른다.</p><p><strong>Data source name</strong> 을 설정하는데 여기선 공백이 먹지 않으므로 다이나모디비 프리픽스를 붙이고 파스칼 케이스로 이름을 정했다.</p><p><code>DDB_DevDeptnoUser</code></p><p><strong>Data source type</strong> 에서는 <code>Amazon DynamoDB Table</code> 을 선택한다.</p><p><strong>Region</strong> 은 서울이므로 <code>AP-NORTHEAST-2</code> 를 선택한다.</p><p><strong>Table name</strong> 은 아까 생성한 <code>Dev Deptno User</code> 를 선택하거나 입력한다.</p><blockquote><p><span class="github-emoji" title="thinking" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f914.png?v8">&#x1f914;</span> 가끔 테이블을 제대로 불러오지 못하니 그럴경우 그냥 입력한다.</p></blockquote><p><strong>Create or use an existing role</strong> 에서는 <code>New role</code> 을 선택한다.</p><p><strong>Automatically generate GraphQL</strong> 를 활성화하면 친절하게도 스키마를 바로 뽑아준다. 활성화 하자.</p><p><img src="appsync-datasource-setting.png" alt="appsync-datasource-setting"></p><p><strong>Create</strong> 를 눌러 데이터 소스를 생성하자. 생성이 완료되면 <strong>Schema</strong> 섹션으로 이동해서 스키마가 잘 생성됐는지 확인한다. 생성된 스키마에 대한 테스트는 바로 아래 섹션인 <strong>Queries</strong> 에 <strong>Graphiql</strong> 느낌의 클라이언트가 들어가있어 바로 확인이 가능하다.</p><p>이제 생성된 <strong>AppSync API</strong> 정보를 바탕으로 <code>configure.js</code> 파일을 업데이트 하자.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//configure.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;AUTH_TYPE&#125; <span class="keyword">from</span> <span class="string">'aws-appsync/lib'</span></span><br><span class="line"><span class="keyword">const</span> configuration = &#123;</span><br><span class="line">  Auth: &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  aws_appsync_graphqlEndpoint: <span class="string">'https://xxx.appsync-api.xx-xxxxx.amazonaws.com/graphql'</span>,</span><br><span class="line">  aws_appsync_region: <span class="string">'xx-xxxx-x'</span>,</span><br><span class="line">  aws_appsync_authenticationType: AUTH_TYPE.AWS_IAM,</span><br><span class="line">  graphql_endpoint_iam_region: <span class="string">'xx-xxxx-x'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>API Details</strong> 에 있는 <strong>API URL</strong> 이 <code>aws_appsync_graphqlEndpoint</code> 다. <code>aws_appsync_region</code>, <code>graphql_endpoint_iam_region</code> 은 모두 도쿄에서 생성했으므로 <code>ap-northeast-1</code> 을 넣어주면 된다. <code>aws_appsync_authenticationType</code> 은 <code>&quot;AWS_IAM&quot;</code> 인데 상수가 정의되어 있으므로 그를 이용한다.</p><blockquote><p><span class="github-emoji" title="information_desk_person" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f481.png?v8">&#x1f481;</span> AUTH_TYPE</p></blockquote><p><code>AUTH_TYPE</code> 에 따른 추가적인 데이터가 반드시 필요하다.</p><ul><li>AWS_IAM - <code>graphql_endpoint_iam_region</code></li><li>AWS_API - <code>aws_appsync_apiKey</code></li><li>AMAZON_COGNITO_USER_POOLS -</li></ul><h2><span id="front-end">Front-end</span></h2><p>드디어 프론트엔드다. 그럼 이제 설정만 있는 프론트엔드 프로젝트를 고도화해보자.</p><h3><span id="nextjs">Next.js</span></h3><p><strong>Next.js</strong> 기반이므로 그에 대한 구조를 갖춰주자. <strong>Next.js</strong> 는 <code>pages</code> 디렉토리 밑을 통해 라우팅이 된다는 점이 특징이니 따로 라우터 설정은 하지 않아도 된다. CRA(<code>create-react-app</code>) 의 컨벤션 룰이 내겐 너무 갑갑해서 사용하는 것일 뿐 어려운 점은 없다. 그냥 파일 두개를 만들면 된다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir pages</span><br><span class="line">touch pages/index.jsx</span><br><span class="line">touch graphql.js</span><br></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pages/index.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../configure'</span></span><br><span class="line"><span class="keyword">import</span> &#123;createUser, getUsers&#125; <span class="keyword">from</span> <span class="string">'../graphql'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  readonly state = &#123;</span><br><span class="line">    users: <span class="literal">null</span>,</span><br><span class="line">    email: <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        Hello world!&lt;br/&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.users &amp;&amp; &lt;pre&gt;&#123;JSON.stringify(this.state.users, null, 2)&#125;&lt;/pre&gt;&#125;</span><br><span class="line">        &lt;form onSubmit=&#123;<span class="keyword">this</span>.handleOnSubmit&#125;&gt;</span><br><span class="line">          &lt;input</span><br><span class="line">						type=<span class="string">"text"</span></span><br><span class="line">						value=&#123;<span class="keyword">this</span>.state.email&#125;</span><br><span class="line">						onChange=&#123;<span class="keyword">this</span>.handleOnChangeEmail&#125;</span><br><span class="line">					/&gt;</span><br><span class="line">          &lt;button&gt;추가&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>form&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  async componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">    this.users()</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  async users() &#123;</span></span><br><span class="line"><span class="regexp">    this.setState(&#123;users: await getUsers()&#125;)</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  handleOnChangeEmail = (e) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    this.setState(&#123;email: e.target.value&#125;)</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  handleOnSubmit = async (e) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    e.preventDefault()</span></span><br><span class="line"><span class="regexp">    await createUser(this.state.email)</span></span><br><span class="line"><span class="regexp">    this.users()</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//graphql.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;API, graphqlOperation&#125; <span class="keyword">from</span> <span class="string">'aws-amplify'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getUsers = <span class="function"><span class="params">()</span> =&gt;</span> API</span><br><span class="line">  .graphql(graphqlOperation(queryUsers))</span><br><span class="line">  .catch(<span class="function"><span class="params">_</span> =&gt;</span> [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createUser = <span class="function">(<span class="params">email: string</span>) =&gt;</span> API</span><br><span class="line">  .graphql(graphqlOperation(mutationCreateUser, &#123;email&#125;))</span><br><span class="line">  .catch(<span class="function"><span class="params">_</span> =&gt;</span> <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queryUsers = <span class="string">`query DeptnoUsers &#123;</span></span><br><span class="line"><span class="string">  listDeptnoUsers &#123;</span></span><br><span class="line"><span class="string">    items &#123;</span></span><br><span class="line"><span class="string">      email</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    nextToken</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutationCreateUser = <span class="string">`mutation CreateDeptnoUser($email: String!) &#123;</span></span><br><span class="line"><span class="string">  createDeptnoUser(input: &#123;email: $email&#125;) &#123;</span></span><br><span class="line"><span class="string">    email</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br></pre></td></tr></table></figure><p>코드에 대한 설명은 따로 필요 없을 것 같다. <strong>React</strong> 와 <strong>GraphQL</strong> 에 대한 지식이 조금 있으면 된다. <strong>query</strong> 는 AWS 콘솔에서 <strong>AppSync</strong>, 생성한 API를 선택한후 <strong>Schema</strong> 누르면 참조할 수 있다.</p><h3><span id="실행">실행</span></h3><p>이제 코드를 만들었으니 실행을 하면 된다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx next</span><br></pre></td></tr></table></figure><hr><h2><span id="연관-링크">연관 링크</span></h2><p>깃허브에 코드가 공개되어 있으며 코드는 타입스크립트를 기준으로 짜여졌으나 이해하기에 다르지 않다.</p><p><a href="https://github.com/deptno/aws-appsync-iam-example" target="_blank" rel="noopener">https://github.com/deptno/aws-appsync-iam-example</a> 예제 코드 깃허브 저장소.</p><p><a href="https://blog.bglee.me/posts/2018/aws-appsync-iam">https://blog.bglee.me/posts/2018/aws-appsync-iam</a> 본 글의 블로그 포스트.</p><hr><h2><span id="부록">부록</span></h2><blockquote><p><span class="github-emoji" title="information_desk_person" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f481.png?v8">&#x1f481;</span> <code>aws-amplify-react</code> 를 사용하면 인증에 대한 처리 분기를 리액트에서 보다 쉽게 할 수 있다. <a href="https://aws-amplify.github.io/amplify-js/media/quick_start#add-user-authentication-to-your-app" target="_blank" rel="noopener">공식 문서</a></p></blockquote><blockquote><p><span class="github-emoji" title="information_desk_person" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f481.png?v8">&#x1f481;</span> <code>aws-appsync-react</code> 패키지는 <code>apollo-react</code> 를 사용할때 오프라인 제어 및 로컬 캐싱을 위한 지원이 있는 것으로 보인다. <code>apollo-react</code> 의 사용 유저라면 반드시 문서를 참조해보도록 한다. <a href="https://github.com/awslabs/aws-mobile-appsync-sdk-js#readme" target="_blank" rel="noopener">깃허브</a></p></blockquote></div><div class="article-tags"><a class="tag-link" href="../../../tags/amplify/">amplify</a><a class="tag-link" href="../../../tags/aws/">aws</a><a class="tag-link" href="../../../tags/cognito/">cognito</a><a class="tag-link" href="../../../tags/dynamodb/">dynamodb</a><a class="tag-link" href="../../../tags/graphql/">graphql</a><a class="tag-link" href="../../../tags/iam/">iam</a><a class="tag-link" href="../../../tags/role/">role</a><a class="tag-link" href="../../../tags/unauthenticated/">unauthenticated</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="http://blog.bglee.me">봉로그</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="https://avatars1.githubusercontent.com/u/1223020?s=400&u=c3a99ef61b76bff024adc28d0c884265fbea98a0&v=4"></div><div class="info"><a class="name dark-btn" href="../../../index.htmlabout">deptno@gmail.com</a></div><div class="info"><span class="item desc">코드를 넘어</span></div></div><div class="social clearfix"><a href="https://medium.com/feed/@deptno" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto:deptno@gmail.com" class="mail" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/deptno" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://twitter.com/deptno" class="twitter" target="_blank" rel="external"><span class="icon icon-twitter"></span> </a><a href="https://plus.google.com/u/0/+이봉균" class="google" target="_blank" rel="external"><span class="icon icon-google"></span> </a><a href="https://www.facebook.com/bonggyun.lee.7" class="facebook" target="_blank" rel="external"><span class="icon icon-facebook"></span> </a><a href="https://www.linkedin.com/in/bonggyun-lee-b55359b3/" class="linkedin" target="_blank" rel="external"><span class="icon icon-linkedin"></span> </a><a href="https://www.instagram.com/deptno/" class="instagram" target="_blank" rel="external"><span class="icon icon-instagram"></span> </a><a href="../../../atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="../../../js/search.js"></script><script src="../../../js/app.js"></script><script type="text/javascript">var disqus_shortname="deptno",disqus_url="http://blog.bglee.me/posts/2018/aws-appsync-iam/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>